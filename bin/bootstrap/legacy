#!/usr/bin/env bash
set -euo pipefail

# =============================================================================
# Modular, Idempotent .dotfiles Initialization Script
# =============================================================================
# Responsibilities:
# - Setup XDG directories
# - Configure shell environment (zsh, bash, fish)
# - Detect OS and perform preflight checks
# - Install Homebrew and dependencies
# - Setup SSH keys
# - Bootstrap chezmoi
# - Initialize taskfiles
# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# Root path & core libraries
# -----------------------------------------------------------------------------
DOTFILES_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
export DOTFILES_ROOT

# Source environment defaults
source "$DOTFILES_ROOT/lib/env.sh"

# Source logging and helper utilities
source "$DOTFILES_ROOT/lib/log.sh"
source "$DOTFILES_ROOT/lib/run.sh"

# Trap for uncaught errors
trap 'log_error "Error on line $LINENO. See $LOG_FILE"; exit 1' ERR

log "ðŸš€ Starting .dotfiles initialization..."

# -----------------------------------------------------------------------------
# XDG directories
# -----------------------------------------------------------------------------
source "$DOTFILES_ROOT/lib/xdg.sh"
setup_xdg_dirs

# -----------------------------------------------------------------------------
# Shell integration
# -----------------------------------------------------------------------------
source "$DOTFILES_ROOT/lib/shell.sh"
setup_shell_integration

# -----------------------------------------------------------------------------
# OS detection & preflight
# -----------------------------------------------------------------------------
source "$DOTFILES_ROOT/lib/os.sh"
detect_os

source "$DOTFILES_ROOT/lib/preflight.sh"
preflight_checks git curl

source "$DOTFILES_ROOT/lib/os-preflight.sh"
os_preflight

# -----------------------------------------------------------------------------
# Homebrew setup
# -----------------------------------------------------------------------------
source "$DOTFILES_ROOT/lib/homebrew.sh"
install_homebrew
setup_homebrew_env

# -----------------------------------------------------------------------------
# Dependencies installation
# -----------------------------------------------------------------------------
source "$DOTFILES_ROOT/lib/dependencies.sh"
install_dependencies

# -----------------------------------------------------------------------------
# SSH key setup
# -----------------------------------------------------------------------------
source "$DOTFILES_ROOT/lib/ssh-key-helper.sh"
setup_ssh_key

# -----------------------------------------------------------------------------
# Chezmoi initialization
# -----------------------------------------------------------------------------
source "$DOTFILES_ROOT/lib/chezmoi-init.sh"
init_chezmoi

# -----------------------------------------------------------------------------
# Taskfile initialization
# -----------------------------------------------------------------------------
source "$DOTFILES_ROOT/lib/task-init.sh"
run_task_init

# -----------------------------------------------------------------------------
# Completion
# -----------------------------------------------------------------------------
log "ðŸŽ‰ .dotfiles initialization complete! Restart your shell to apply XDG paths and mise environment."
