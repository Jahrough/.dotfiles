#!/usr/bin/env bash
# =============================================================================
# update-brew.sh
# Idempotent Homebrew maintenance script with retries and logging
# =============================================================================

set -euo pipefail

# Configurable environment
LOG_FILE="${DOTFILES_LOG:-$HOME/.local/state/dotfiles-setup.log}"
RETRIES="${RETRIES:-3}"
RETRY_DELAY="${RETRY_DELAY:-5}"

echo "[INFO] Starting Homebrew maintenance..." | tee -a "$LOG_FILE"

# Ensure Homebrew is installed
if ! command -v brew &>/dev/null; then
  echo "[ERROR] Homebrew is not installed. Exiting." | tee -a "$LOG_FILE"
  exit 1
fi

run_with_retry() {
  local cmd="$1"
  for i in $(seq 1 "$RETRIES"); do
    if eval "$cmd"; then
      return 0
    else
      echo "[WARN] Command failed (attempt $i/$RETRIES). Retrying in $RETRY_DELAY sec..." | tee -a "$LOG_FILE"
      sleep "$RETRY_DELAY"
    fi
  done
  echo "[ERROR] Command failed after $RETRIES attempts: $cmd" | tee -a "$LOG_FILE"
  return 1
}

# Update, upgrade, cleanup, and doctor
run_with_retry "brew update 2>&1 | tee -a \"$LOG_FILE\""
run_with_retry "brew upgrade 2>&1 | tee -a \"$LOG_FILE\""
run_with_retry "brew cleanup 2>&1 | tee -a \"$LOG_FILE\""
run_with_retry "brew doctor 2>&1 | tee -a \"$LOG_FILE\""

echo "[INFO] Homebrew maintenance complete!" | tee -a "$LOG_FILE"
